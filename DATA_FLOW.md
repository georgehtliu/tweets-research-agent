# How Data Flows (Beginner Guide)

A simple map of **where your query goes** and **what happens to it** from the moment you click "Generate" to when you see the final summary.

---

## The Big Picture

```
You type a query  →  Web UI  →  API  →  Agent  →  Data + Grok  →  Summary back to you
```

---

## Step-by-Step Flow

### 1. You Submit a Query

- **Where:** Browser (`client/static/index.html` + `script.js`)
- **What happens:** You type something like "What are people saying about AI?" and click **Generate**.
- **Data:** Just the text you typed → sent as `{ "query": "..." }` to the server.

---

### 2. API Receives the Query

- **Where:** `server/routes/query.py` — `POST /api/query`
- **What happens:**
  - Validates the query (not empty).
  - Loads or creates the **agent** (which uses **data** + **Grok**).
  - Starts the **workflow** in a background thread.
  - Streams **progress events** (planning, executing, etc.) back to the browser over Server-Sent Events (SSE).

- **Data flow:** `query` (string) → agent → progress events (JSON) streamed to the UI.

---

### 3. Agent Runs the Workflow

- **Where:** `server/agent.py` — `run_workflow(query)`
- **What happens:** The agent moves through these steps **in order** (sometimes loops back if it needs to refine or replan):

| Step       | What happens | Data in → Data out |
|------------|--------------|---------------------|
| **Plan**   | Grok turns your query into a plan (search steps, filters, etc.) | `query` → `plan` (JSON) |
| **Execute**| Uses **retrieval** to fetch posts from the dataset that match the plan | `plan` + `query` → `results` (list of posts) |
| **Analyze**| Grok looks at the retrieved posts and extracts themes, sentiment, insights | `query` + `results` + `plan` → `analysis` (JSON) |
| **Evaluate**| Decides: "Is the strategy wrong? Do we need a **new plan**?" | `analysis` + `plan` + `results` → `replan?` (yes/no) |
| **Refine** | If confidence is low: "Do we need **more searches**?" Optional extra searches. | `analysis` + `plan` → `refinement` (more searches or stop) |
| **Critique**| Checks the analysis/summary for hallucinations and bias | `analysis` + `summary` + `results` → `critique` (pass/fail + issues) |
| **Summarize**| Grok writes the final answer you see | `query` + `plan` + `analysis` → `summary` (text) |

- **Data flow:**  
  `query` → `plan` → `results` → `analysis` → (maybe replan/refine) → `critique` → `summary`.

---

### 4. Where the Data Comes From

- **Dataset:** `data/mock_x_data.json` (or generated by `server/data_generator.py` if missing).
- **Retrieval:** `server/retrieval.py` — **HybridRetriever** searches that data (keyword + semantic) and returns matching posts.
- **Grok:** `server/grok_client.py` — **GrokClient** sends prompts to the Grok API and gets back plans, analyses, and the summary.

So: **your query** + **posts from the dataset** + **Grok’s reasoning** = **final summary**.

---

### 5. Result Back to You

- **Where:** `server/routes/query.py` sends a final SSE message: `{ "type": "complete", "result": { ... } }`.
- **What the UI does:** `script.js` receives it, calls `formatResult(...)`, and shows:
  - **Metadata:** query type, result count, confidence, etc.
  - **Final summary**
  - **Analysis** (themes, insights, sentiment)
  - **Critique** (if we ran it)
  - **Plan** (the steps the agent followed)

- **Data flow:** `result` (JSON) → HTML rendered in the browser.

---

## Visual Summary

```
┌─────────────┐     POST /api/query      ┌─────────────┐
│   Browser   │ ──────────────────────►  │  API        │
│   (UI)      │  { "query": "..." }      │  (FastAPI)  │
└──────┬──────┘                          └──────┬──────┘
       │                                        │
       │  SSE progress + final result            │  run_workflow(query)
       │ ◄───────────────────────────────────── │
       │                                        ▼
       │                               ┌─────────────────┐
       │                               │  Agent          │
       │                               │  plan → execute │
       │                               │  → analyze → …  │
       │                               └────────┬────────┘
       │                                        │
       │                    ┌───────────────────┼───────────────────┐
       │                    ▼                   ▼                   ▼
       │             ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
       │             │  Data       │     │  Retrieval  │     │  Grok API   │
       │             │  (JSON)     │     │  (search)   │     │  (LLM)      │
       │             └─────────────┘     └─────────────┘     └─────────────┘
       │
       ▼
  You see the summary, analysis, and plan.
```

---

## Key Files

| File | Role |
|------|------|
| `client/static/script.js` | Sends query, receives SSE, renders results |
| `server/routes/query.py` | API endpoint, runs workflow, streams SSE |
| `server/agent.py` | Orchestrates plan → execute → analyze → … → summarize |
| `server/retrieval.py` | Searches the dataset (hybrid search) |
| `server/grok_client.py` | Calls Grok API |
| `data/mock_x_data.json` | The posts we search over |

---

## TL;DR

1. **You** send a **query** from the UI.
2. The **API** runs the **agent** with that query.
3. The **agent** **plans** → **fetches posts** from **data** via **retrieval** → **analyzes** them with **Grok** → optionally **refines** or **replans** → **critiques** → **summarizes**.
4. The **API** streams **progress** and the **final result** back.
5. The **UI** shows the **summary**, **analysis**, and **plan**.

Data flows: **query → plan → results → analysis → summary → you.**
